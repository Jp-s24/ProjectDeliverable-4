  pipeline {
  agent any
  tools {
    maven 'maven'
    googleCloudSdk 'google-cloud-sdk'
  }
  environment {
    PROJECT_ID = 'project-4-quality'
    CLUSTER_NAME = 'sofe3980u'
    ZONE = 'northamerica-northeast1-b'
    IMAGE_NAME = 'binarycalculator'
    TAG = 'gcr.io/fluid-mind-379620'
    KUBECONFIG = '/tmp/kubeconfig'
  }
  stages {
    stage ('Init') {
      steps {
        sh 'echo "Start of Job"'
        sh 'ls -la'
      }
    }
    stage ('test') {
      steps {
        sh 'mvn clean test -f ./BinaryCalculatorWebapp/pom.xml'
      }
    }
    stage ('build') {
      steps {
        sh 'mvn package -DskipTests -f ./BinaryCalculatorWebapp/pom.xml'
        sh "gcloud auth activate-service-account --key-file=<path-to-your-service-account-key>"
        sh "gcloud container builds submit --tag gcr.io/${PROJECT_ID}/${IMAGE_NAME}:${TAG} ./BinaryCalculatorWebapp"
      }
    }
    stage ('Deploy') {
      steps {
        sh "gcloud container clusters get-credentials ${CLUSTER_NAME} --zone ${ZONE} --project ${PROJECT_ID}"
        sh "kubectl config use-context gke_${PROJECT_ID}_${ZONE}_${CLUSTER_NAME}"
        sh "kubectl set image deployment/binary-calculator-webapp binary-calculator-webapp=gcr.io/${PROJECT_ID}/${IMAGE_NAME}:${TAG}"
      }
    }
  }
}

